<!DOCTYPE html>
<html lang="en">
<head>
<script src="signalr.min.js"></script>    
<script src="jquery.min.js"></script>   
<script>
    $(document).ready(() => {
        const connection = new signalR.HubConnectionBuilder()
        .withUrl("https://localhost:5001/messagehub", {
      skipNegotiation: true,
      transport: signalR.HttpTransportType.WebSockets})
        .withAutomaticReconnect([1000, 1000, 2000, 3000, 5000, 10000]) //0 - 2 - 10 - 30 saniye aralıklarla bağlanmayı deneyecek
        .build();

        async function start(){
            try {
                connection.start();
            } catch (error) {
                setTimeout(()=> start(), 2000); 
            }
        }
        //connection.start();
        start();

        function animation(){
            durum.fadeIn(2000,()=> {
                setTimeout(() => {durum.fadeOut(2000);
                }, 2000)
            });
        }
        const durum = $("#durum");
        connection.onreconnecting(error => {
            durum.css("background-color","blue");
            durum.css("color","white");
            durum.html("Bağlantı kuruluyor......");
            animation();
        });
        connection.onreconnected(connectionId => {
            durum.css("background-color","green");
            durum.css("color","white");
            durum.html("Bağlantı kuruldu......");
            animation();
        });
        connection.onclose(connectionId => {
            durum.css("background-color","red");
            durum.css("color","white");
            durum.html("Bağlanılamadı......");
            animation();
        });
       
        //#region ESKİ
        // connection.on("userJoined", connectionId => {
        //     durum.html(`${connectionId} bağlandı.`);
        //     durum.css("background-color","green");
        //     animation();
        // });
        // connection.on("userLeft", connectionId => {
        //     durum.html(`${connectionId} ayrıldı.`);            
        //     durum.css("background-color","red");
        //     animation();
        // });

        // connection.on("clients", clientsData => {
        //     let text  ="";
        //     $.each(clientsData, (index, item) => {
        //         text += `<li>${item}</li>`;
        //         $("#clients").html(text);
        //     });
        // });
//#endregion
       
        $("#btnGonder").click(()=> {
            let message = $("#txtMessage").val();
            let connectionIds = $("#connectionIds").val().split(",");
            connection.invoke("SendMessage",message,connectionIds).catch(error => console.log(`Mesaj gönderilirken hata oluştu. ${error}`));
        });
        connection.on("receiveMessage", message => {
        $("#mesajlar").append(message + "<br>");
        });
        //Bağlantı hiç oluşturulmazsa
        connection.on("getConnectionId", connectionId=> {
            $("#connectionId").html(`Connection Id : ${connectionId}`);
        });

    });
</script> 
</head>
<body>
<div style="background-color: black; color: white;" id="connectionId"></div>

    <div id = "durum" style="display: none;"></div>
    <input type="text" id="txtMessage">
    <textarea id="connectionIds" cols="30" rows="10"></textarea>
    <button id="btnGonder">Gönder</button>
    <div id = "mesajlar" ></div>

    <!-- <div>
        <ul id="clients">

        </ul>
    </div> -->
</body>
</html>